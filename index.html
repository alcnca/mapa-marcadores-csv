<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa con marcadores desde CSV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha384-sA+e+h+RWlqIpl97TmkY7c/ErjMNJGhK91eqG5sT+9ViN0kh41V4Ilj+oYyVXjGi" 
    crossorigin=""
  />
  <style>
    #map { height: 600px; }
    #filters { margin: 10px 0; }
  </style>
</head>
<body>

  <h2>Mapa con marcadores desde CSV</h2>

  <input type="file" id="csvFile" accept=".csv" />
  <div id="filters"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([20.97, -89.62], 6); // Centrado en Yucatán
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];
    let categoryLayers = {};

    document.getElementById('csvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        complete: function(results) {
          clearMap();
          const data = results.data;
          const categories = new Set();
          data.forEach(row => {
            const lat = row.latitud || row.Latitud;
            const lng = row.longitud || row.Longitud;
            const name = row.nombre || row.Nombre || 'Sin nombre';
            const color = row.color || row.Color || 'blue';
            const category = row.categoria || row.Categoria || 'General';

            if (!lat || !lng) return;

            const marker = L.circleMarker([lat, lng], {
              radius: 8,
              color: color,
              fillColor: color,
              fillOpacity: 0.8
            }).bindPopup(`<strong>${name}</strong><br>Categoría: ${category}`);

            if (!categoryLayers[category]) {
              categoryLayers[category] = L.layerGroup();
            }

            marker.addTo(categoryLayers[category]);
            markers.push(marker);
            categories.add(category);
          });

          // Mostrar todos los grupos
          Object.values(categoryLayers).forEach(layer => layer.addTo(map));
          // Agregar filtros
          renderFilters([...categories]);
        }
      });
    });

    function renderFilters(categories) {
      const filtersDiv = document.getElementById('filters');
      filtersDiv.innerHTML = '<strong>Filtrar por categoría:</strong><br>';
      categories.forEach(category => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = category;
        checkbox.checked = true;
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            categoryLayers[category].addTo(map);
          } else {
            map.removeLayer(categoryLayers[category]);
          }
        });

        const label = document.createElement('label');
        label.htmlFor = category;
        label.textContent = category;

        filtersDiv.appendChild(checkbox);
        filtersDiv.appendChild(label);
        filtersDiv.appendChild(document.createElement('br'));
      });
    }

    function clearMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      for (let key in categoryLayers) {
        map.removeLayer(categoryLayers[key]);
      }
      categoryLayers = {};
      document.getElementById('filters').innerHTML = '';
    }
  </script>
</body>
</html>